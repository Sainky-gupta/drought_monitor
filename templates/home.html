{% extends "base.html" %}

{% block content %}

<div class="hero">
    <h1><i class="fas fa-seedling"></i> Drought Monitoring System</h1>
    <p>AI-powered agricultural drought prediction at district level across India. Get early warnings and make informed decisions.</p>
</div>

<div class="predict-form">
    <h2><i class="fas fa-chart-line"></i> Predict Drought Conditions</h2>
    <form id="predictionForm">
        <div class="form-grid">
            <div class="form-group">
                <label for="state"><i class="fas fa-map-marker-alt"></i> State</label>
                <select id="state" name="state" required>
                    <option value="">Select State</option>
                    {% for state in states %}
                        <option value="{{ state }}">{{ state }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="district"><i class="fas fa-city"></i> District</label>
                <select id="district" name="district" required disabled>
                    <option value="">Select District</option>
                </select>
            </div>

            <div class="form-group">
                <label for="year"><i class="fas fa-calendar"></i> Year</label>
                <select id="year" name="year" required>
                    <option value="">Select Year</option>
                    {% for year in years %}
                        <option value="{{ year }}">{{ year }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="month"><i class="fas fa-calendar-alt"></i> Month</label>
                <select id="month" name="month" required>
                    <option value="">Select Month</option>
                    {% for month in months %}
                        <option value="{{ month[0] }}">{{ month[1] }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <button type="submit" class="btn" id="predictBtn">
            <i class="fas fa-search"></i> Predict Drought Condition
        </button>
    </form>
</div>

<div id="resultContainer" class="result-container" style="display: none;">
    <div class="result-header">
        <div class="drought-status" id="droughtStatus">
            <i class="fas fa-exclamation-triangle"></i> <span id="droughtText">Loading...</span>
        </div>
        <div class="cdi-value">
            CDI: <span id="cdiValue">-</span>
        </div>
    </div>

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-cloud-rain" style="color: #3b82f6;"></i>
            </div>
            <div class="metric-label">Rainfall (SPI-3)</div>
            <div class="metric-value">
                <span id="rainfallValue">-</span>
                <span class="metric-unit">%</span>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #6b7280;">
                SPI-3: <span id="spi3Value">-</span>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-leaf" style="color: #10b981;"></i>
            </div>
            <div class="metric-label">Vegetation (NDVI)</div>
            <div class="metric-value">
                <span id="vegetationValue">-</span>
                <span class="metric-unit">%</span>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #6b7280;">
                Anomaly: <span id="ndviValue">-</span>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-water" style="color: #06b6d4;"></i>
            </div>
            <div class="metric-label">Soil Moisture</div>
            <div class="metric-value">
                <span id="soilMoistureValue">-</span>
                <span class="metric-unit">%</span>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #6b7280;">
                Deficit: <span id="smDeficitValue">-</span>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // State-District filtering
    const stateSelect = document.getElementById('state');
    const districtSelect = document.getElementById('district');

    stateSelect.addEventListener('change', async function() {
        const state = this.value;
        districtSelect.disabled = true;
        districtSelect.innerHTML = '<option value="">Loading districts...</option>';

        if (state) {
            try {
                const response = await fetch(`/api/districts/${encodeURIComponent(state)}`);
                const districts = await response.json();
                
                districtSelect.innerHTML = '<option value="">Select District</option>';
                districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });
                districtSelect.disabled = false;
            } catch (error) {
                console.error('Error fetching districts:', error);
                districtSelect.innerHTML = '<option value="">Error loading districts</option>';
            }
        } else {
            districtSelect.innerHTML = '<option value="">Select District</option>';
        }
    });

    // Prediction form submission
    const form = document.getElementById('predictionForm');
    const resultContainer = document.getElementById('resultContainer');
    const predictBtn = document.getElementById('predictBtn');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
            state: stateSelect.value,
            district: districtSelect.value,
            year: document.getElementById('year').value,
            month: document.getElementById('month').value
        };

        // Validate
        if (!formData.state || !formData.district || !formData.year || !formData.month) {
            alert('Please fill in all fields');
            return;
        }

        // Show loading state
        predictBtn.disabled = true;
        predictBtn.innerHTML = '<span class="loading"></span> Predicting...';
        resultContainer.style.display = 'none';

        try {
            const response = await fetch('/api/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (data.success) {
                // Update UI with results
                document.getElementById('droughtText').textContent = data.drought_class;
                document.getElementById('cdiValue').textContent = data.cdi;
                
                const droughtStatus = document.getElementById('droughtStatus');
                droughtStatus.className = `drought-status ${data.drought_class_name}`;
                
                // Update icons based on drought class
                const icon = droughtStatus.querySelector('i');
                if (data.drought_class_name === 'severe') {
                    icon.className = 'fas fa-exclamation-circle';
                } else if (data.drought_class_name === 'moderate') {
                    icon.className = 'fas fa-exclamation-triangle';
                } else if (data.drought_class_name === 'mild') {
                    icon.className = 'fas fa-info-circle';
                } else {
                    icon.className = 'fas fa-check-circle';
                }

                // Update metrics
                document.getElementById('rainfallValue').textContent = data.rainfall;
                document.getElementById('spi3Value').textContent = data.spi_3;
                document.getElementById('vegetationValue').textContent = data.vegetation;
                document.getElementById('ndviValue').textContent = data.ndvi;
                document.getElementById('soilMoistureValue').textContent = data.soil_moisture;
                document.getElementById('smDeficitValue').textContent = data.sm_deficit;

                // Show results
                resultContainer.style.display = 'block';
                resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                alert('Error: ' + (data.error || 'Failed to get prediction'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        } finally {
            predictBtn.disabled = false;
            predictBtn.innerHTML = '<i class="fas fa-search"></i> Predict Drought Condition';
        }
    });
</script>
{% endblock %}
